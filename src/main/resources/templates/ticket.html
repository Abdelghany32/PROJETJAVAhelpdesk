<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Ticket</title>
    <div th:replace="~{base :: head}"></div>
    <style>
        .botoes {
            display: flex;
            flex-direction: row;
        }
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
        }
        .file-upload-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .file-list {
            margin-left: 10px;
            color: #666;
        }
        .attachment-item {
            margin-bottom: 5px;
        }
        .attachment-item a {
            text-decoration: none;
        }
    </style>
</head>
<header>
    <div th:replace="~{base :: logo-al}"></div>
</header>
<body>
<div class="container" style="height: 100%">
    <div class="overflow-auto d-flex flex-column-reverse" style="max-height:50%">
        <div>
            <div class="d-flex flex-column justify-content-end" th:each="message : ${ticket.messages}" style="width: 100%;">
                <div th:classappend="${username} == ${message.author.getUsername()} ? 'align-self-end' : 'align-self-start'"
                     class="card p-2 mt-2"
                     style="width: 70%;">
                    <div th:text="${message.text}" class="card-body">
                        Message
                    </div>

                    <!-- Affichage des pièces jointes -->
                    <div th:if="${not #lists.isEmpty(message.attachments)}" class="message-attachments mt-2">
                        <div th:each="attachment : ${message.attachments}" class="attachment-item">
                            <a th:href="@{/ticket/attachments/{id}/download(id=${attachment.id})}"
                               class="text-decoration-none d-flex align-items-center">
                                <i th:if="${attachment.image}" class="fas fa-image text-primary me-2"></i>
                                <i th:if="${attachment.pdf}" class="fas fa-file-pdf text-danger me-2"></i>
                                <i th:unless="${attachment.image or attachment.pdf}" class="fas fa-file text-secondary me-2"></i>
                                <span th:text="${attachment.fileName}"></span>
                            </a>

                            <!-- Prévisualisation des images -->
                            <div th:if="${attachment.image}" class="mt-2">
                                <img th:src="@{/ticket/attachments/{id}/view(id=${attachment.id})}"
                                     class="img-fluid"
                                     style="max-width: 200px; max-height: 200px; object-fit: contain;">
                            </div>
                        </div>
                    </div>

                    <div class="card-footer text-muted small d-flex justify-content-between">
                        <a th:text="${message.author.username}"></a>
                        <a th:text="${#temporals.format(message.sendDate, 'dd-MM-yyyy HH:mm')}"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de réponse -->
    <form th:if="${ticket.status.name()} != 'FINALIZADO'"
          th:action="@{'/ticket/' + ${ticket.id} + '/send'}"
          method="post"
          th:object="${message}"
          id="form-send"
          enctype="multipart/form-data">
            <textarea th:field="*{text}"
                      class="mt-2 form-control"
                      placeholder="Écrivez votre message ici..."></textarea>

        <!-- Champ pour les pièces jointes -->
        <div class="file-upload-container">
            <label class="btn btn-outline-secondary btn-sm">
                <input type="file" name="files" multiple style="display: none;" onchange="updateFileList(this)">
                <i class="fas fa-paperclip me-2"></i>Joindre des fichiers
            </label>
            <span id="file-list" class="file-list"></span>
        </div>

        <div class="botoes mt-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>Envoyer
            </button>
        </div>
    </form>

    <!-- Message si le ticket est fermé -->
    <div th:if="${ticket.status.name()} == 'FINALIZADO'" class="alert alert-info mt-3">
        Ce ticket a été fermé et ne peut plus recevoir de messages.
    </div>
</div>

<script>
    function updateFileList(input) {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';

        if (input.files.length > 0) {
            const fileNames = Array.from(input.files)
                .map(file => file.name)
                .join(', ');
            fileList.textContent = fileNames;
        }
    }
</script>
</body>
</html>